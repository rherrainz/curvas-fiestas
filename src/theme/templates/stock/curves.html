{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="max-w-6xl mx-auto p-4 sm:p-6 space-y-6">
  <div>
    <h1 class="text-3xl font-bold">Curvas de Stock (diario)</h1>
    <p class="text-sm opacity-70">Per√≠odo 1/oct ‚Äì 31/dic. Comparaci√≥n de <strong>3 a√±os</strong>. Fuente: tiendas/CDR.</p>
  </div>

  <form id="filters" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-4 bg-base-100 p-4 rounded-xl shadow">
    <div>
      <label class="label"><span class="label-text">Fuente</span></label>
      <select class="select select-bordered w-full" name="source" id="source">
        <option value="all"    {% if default_source == 'all' %}selected{% endif %}>Tiendas + CDR</option>
        <option value="stores" {% if default_source == 'stores' %}selected{% endif %}>Solo Tiendas</option>
        <option value="cdr"    {% if default_source == 'cdr' %}selected{% endif %}>Solo CDR</option>
      </select>
    </div>
    <div>
      <label class="label"><span class="label-text">Regi√≥n</span></label>
      <select class="select select-bordered w-full" name="region_id" id="region">
        <option value="">Todas</option>
        {% for r in regions %}<option value="{{ r.id }}">{{ r.name }}</option>{% endfor %}
      </select>
    </div>
    <div>
      <label class="label"><span class="label-text">Zona</span></label>
      <select class="select select-bordered w-full" name="zone_id" id="zone" disabled>
        <option value="">Todas</option>
      </select>
    </div>
    <div>
      <label class="label"><span class="label-text">Sucursal</span></label>
      <select class="select select-bordered w-full" name="store_code" id="store" disabled>
        <option value="">Todas</option>
      </select>
    </div>
    <div class="sm:col-span-2 lg:col-span-3">
      <label class="label"><span class="label-text">Familia (origen)</span></label>
      <select class="select select-bordered w-full" name="family_id" id="family">
        <option value="">Todas</option>
        {% for f in families %}
          <option value="{{ f.id }}">{{ f.origen }} ‚ñ∏ {{ f.familia_std }} ‚ñ∏ {{ f.subfamilia_std }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="sm:col-span-2 lg:col-span-6 flex justify-end">
      <button type="submit" class="btn btn-primary w-full sm:w-auto">Actualizar gr√°fico</button>
    </div>
  </form>

  <div class="bg-base-100 p-4 sm:p-6 rounded-xl shadow">
    <h2 class="text-xl font-semibold mb-4">Stock diario (3 a√±os comparados)</h2>
    <div class="flex justify-end gap-2 mb-2">
      <button id="stockZoomIn" type="button" class="btn btn-xs">+</button>
      <button id="stockZoomOut" type="button" class="btn btn-xs">-</button>
      <button id="stockZoomReset" type="button" class="btn btn-xs">Reset</button>
    </div>
    <div class="relative w-full h-64 sm:h-80">
      <canvas id="stockChart" class="w-full h-full"></canvas>
    </div>
  </div>

  <div class="bg-base-100 p-4 sm:p-6 rounded-xl shadow">
    <h2 class="text-xl font-semibold mb-4">Detalle diario</h2>
<div class="overflow-x-auto">
  <div class="h-[420px] sm:h-[520px] overflow-y-auto">
    <table id="dataTable" class="table table-sm table-pin-rows w-full text-sm">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>
</div>
    <p id="tableNote" class="text-xs opacity-60 mt-2"></p>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2"></script>
<script>
const ZONES_URL  = "{% url 'core:zones_by_region' %}";
const STORES_URL = "{% url 'core:stores_by_zone' %}";
const STORE_URL  = "{% url 'core:store_info' %}";

const $region = document.getElementById('region');
const $zone   = document.getElementById('zone');
const $store  = document.getElementById('store');
const $form   = document.getElementById('filters');
const ctx     = document.getElementById('stockChart').getContext('2d');
const $table  = document.getElementById('dataTable');
const $tableNote = document.getElementById('tableNote');
let chart;
if (window.Chart && window["chartjs-plugin-zoom"]) {
  Chart.register(window["chartjs-plugin-zoom"]);
}

function resetSelect($el, placeholder) {
  $el.innerHTML = '';
  const opt = document.createElement('option');
  opt.value = ''; opt.textContent = placeholder || 'Todas';
  $el.appendChild(opt);
}

async function loadZones(regionId) {
  resetSelect($zone,'Todas'); resetSelect($store,'Todas');
  $zone.disabled = true; $store.disabled = true;
  if (!regionId) { $zone.disabled=false; $store.disabled=false; return; }
  try {
    const r = await fetch(`${ZONES_URL}?region_id=${encodeURIComponent(regionId)}`);
    const data = await r.json();
    for (const z of (data.items||[])) {
      const o = document.createElement('option'); o.value=z.id; o.textContent=z.name; $zone.appendChild(o);
    }
  } finally { $zone.disabled=false; }
}
async function loadStores(zoneId) {
  resetSelect($store,'Todas'); $store.disabled = true;
  if (!zoneId) { $store.disabled=false; return; }
  try {
    const r = await fetch(`${STORES_URL}?zone_id=${encodeURIComponent(zoneId)}`);
    const data = await r.json();
    const items = (data.items || []).slice().sort((a, b) => {
      const na = Number(a.id || a.code || a.label);
      const nb = Number(b.id || b.code || b.label);
      if (!Number.isNaN(na) && !Number.isNaN(nb) && na !== nb) return na - nb;
      return String(a.label || a.id || '').localeCompare(String(b.label || b.id || ''), 'es', { numeric:true, sensitivity:'base' });
    });
    for (const s of items) {
      const o = document.createElement('option'); o.value=s.id; o.textContent=s.label; $store.appendChild(o);
    }
  } finally { $store.disabled=false; }
}

$region.addEventListener('change', e => loadZones(e.target.value));
$zone.addEventListener('change',   e => loadStores(e.target.value));

// Al elegir sucursal: sincronizar regi√≥n/zona autom√°ticamente (evita combinaciones inv√°lidas)
$store.addEventListener('change', async (e) => {
  const code = e.target.value;
  if (!code) return;
  const r = await fetch(`${STORE_URL}?code=${encodeURIComponent(code)}`);
  const data = await r.json();
  if (!data.ok) return;
  // setear regi√≥n y recargar zonas/tiendas en cascada
  $region.value = data.region.id;
  await loadZones(data.region.id);
  $zone.value = data.zone.id;
  await loadStores(data.zone.id);
  $store.value = code;  // re-seleccionar
});

// Helpers de estilo y formato
function getThemeColors() {
  const s = getComputedStyle(document.documentElement);
  const chartKeys = Array.from({ length: 20 }, (_, i) => `--chart-${i + 1}`);
  const chartColors = chartKeys.map(k => (s.getPropertyValue(k) || '').trim()).filter(Boolean);
  const fallback = [
    '#2563eb', '#dc2626', '#16a34a', '#f59e0b', '#7c3aed',
    '#0ea5e9', '#f97316', '#be123c', '#22c55e', '#a855f7',
    '#14b8a6', '#ef4444', '#6366f1', '#84cc16', '#d946ef',
    '#0891b2', '#9333ea', '#0284c7', '#ea580c', '#334155',
  ];

  const palette = [...chartColors];
  while (palette.length < 20) palette.push(fallback[(palette.length - chartColors.length) % fallback.length]);
  return palette.slice(0, 20);
}
function hexToRgba(hex, a) {
  if (!hex) return null;
  const h = hex.replace('#','');
  const full = h.length === 3 ? h.split('').map(c => c + c).join('') : h;
  const bigint = parseInt(full, 16);
  const r = (bigint >> 16) & 255;
  const g = (bigint >> 8) & 255;
  const b = bigint & 255;
  return `rgba(${r}, ${g}, ${b}, ${a})`;
}
function parseYear(label) {
  const m = /(\d{4})/.exec(label || "");
  return m ? Number(m[1]) : null;
}
function pad2(n) { return String(n).padStart(2, '0'); }
function formatDayLabel(label) {
  const m = /^(\d{1,2})-(\d{1,2})$/.exec(label || "");
  if (m) return `${pad2(m[2])}/${pad2(m[1])}`;
  return label || "";
}
function formatNumber(v) {
  if (v === null || v === undefined || Number.isNaN(Number(v))) return '';
  return Number(v).toLocaleString('es-AR', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
}
function formatPercent(delta) {
  if (delta === null || delta === undefined || Number.isNaN(delta)) return '';
  const num = Number(delta);
  const sign = num > 0 ? '+' : '';
  return `${sign}${num.toLocaleString('es-AR', { minimumFractionDigits: 1, maximumFractionDigits: 1 })}%`;
}
function semaforoEmoji(pct) {
  if (pct === null || pct === undefined || Number.isNaN(pct)) return '';
  if (pct > 10) return 'üü¢';
  if (pct < -10) return 'üî¥';
  return 'üü°';
}
function pctDiff(a, b) {
  if (a === null || a === undefined || b === null || b === undefined || Number(b) === 0) return null;
  return ((Number(a) / Number(b)) - 1) * 100;
}
function clearTable() {
  if (!$table) return;
  $table.querySelector('thead').innerHTML = '';
  $table.querySelector('tbody').innerHTML = '';
  if ($tableNote) $tableNote.textContent = '';
}
function renderTable(labels, datasets) {
  if (!$table) return;
  const thead = $table.querySelector('thead');
  const tbody = $table.querySelector('tbody');
  const yearList = Array.from(new Set(datasets.map(d => parseYear(d.label)).filter(Boolean))).sort((a,b)=>a-b);
  const yearData = new Map();
  datasets.forEach(d => { const y = parseYear(d.label); if (y) yearData.set(y, d.data); });

  const headCols = yearList
  .map(y => `<th class="text-right bg-base-200">${y}</th>`)
  .join('');

thead.innerHTML = `
  <tr>
    <th class="bg-base-200">D√≠a</th>
    ${headCols}
    <th class="text-right bg-base-200">2025 vs 2024 (%)</th>
    <th class="text-right bg-base-200">2025 vs 2023 (%)</th>
  </tr>
`;

  const rows = labels.map((lab, idx) => {
    const valueCells = yearList.map(y => {
      const val = (yearData.get(y) || [])[idx];
      return `<td class="text-right">${formatNumber(val)}</td>`;
    }).join('');
    const v2025 = (yearData.get(2025) || [])[idx];
    const v2024 = (yearData.get(2024) || [])[idx];
    const v2023 = (yearData.get(2023) || [])[idx];
    const pct25_24 = pctDiff(v2025, v2024);
    const pct25_23 = pctDiff(v2025, v2023);
    const diff25_24 = formatPercent(pct25_24);
    const diff25_23 = formatPercent(pct25_23);
    return `<tr><th class="font-normal">${lab}</th>${valueCells}<td class="text-right">${semaforoEmoji(pct25_24)} ${diff25_24}</td><td class="text-right">${semaforoEmoji(pct25_23)} ${diff25_23}</td></tr>`;
  }).join('');
  tbody.innerHTML = rows;

  if ($tableNote) {
    const foundYears = yearList.length ? yearList.join(', ') : '-';
    $tableNote.textContent = `Columnas activas: ${foundYears}. Las comparaciones solo se calculan si hay datos para 2025 y el a√±o base.`;
  }
}


function fetchData() {
  const params = new URLSearchParams(new FormData($form));
  fetch(`/stock/curves/data/?${params.toString()}`)
    .then(r => r.json())
    .then(d => {
      // filtrar series planas
      const filtered = (d.datasets||[]).filter(ds => (ds.data||[]).reduce((a,v)=>a+(Number(v)||0),0) > 0);
      if (filtered.length === 0) {
        if (chart) chart.destroy();
        ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);
        clearTable();
        return;
      }

      const labels = (d.labels || []).map(formatDayLabel);
      const palette = getThemeColors();
      const ds = filtered.map((it, idx) => {
        const color = palette[idx % palette.length] || '#333333';
        const year = parseYear(it.label);
        return {
          label: it.label,
          // Si el valor es 0 o null, lo mostramos como null (Chart.js no dibuja)
          data: it.data.map(v => {
            const n = Number(v);
            return n === 0 ? null : n;
          }),
          tension: 0.3,
          borderWidth: 2,
          spanGaps: true, // Une tramos con datos, sin linea en los nulls
          borderColor: color,
          backgroundColor: hexToRgba(color, 0.12),
          pointBackgroundColor: color,
          fill: false,
          order: -(year ?? idx),
        };
      });

      const cfg = {
        type:'line',
        data:{labels:labels, datasets:ds},
        options:{
          responsive:true,
          maintainAspectRatio:false,
          interaction:{mode:'index',intersect:false},
          scales:{ y:{ beginAtZero:true, ticks:{precision:0} } },
          plugins:{
            legend:{position:'top'},
            zoom:{
              pan:{ enabled:true, mode:'x' },
              zoom:{
                wheel:{ enabled:true },
                pinch:{ enabled:true },
                mode:'x'
              }
            }
          }
        }
      };
      if (chart) chart.destroy(); chart = new Chart(ctx, cfg);
      renderTable(chart.data.labels, chart.data.datasets);
    })
    .catch(console.error);
}

function bindZoomButtons() {
  const btnIn    = document.getElementById('stockZoomIn');
  const btnOut   = document.getElementById('stockZoomOut');
  const btnReset = document.getElementById('stockZoomReset');
  if (btnIn)    btnIn.addEventListener('click', () => { if (chart) chart.zoom(1.2); });
  if (btnOut)   btnOut.addEventListener('click', () => { if (chart) chart.zoom(0.8); });
  if (btnReset) btnReset.addEventListener('click', () => { if (chart) chart.resetZoom(); });
}

$form.addEventListener('submit', e => { e.preventDefault(); fetchData(); });

// init
document.addEventListener('DOMContentLoaded', async () => { bindZoomButtons(); fetchData(); });
</script>
{% endblock %}
