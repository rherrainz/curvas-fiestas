{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="max-w-6xl mx-auto p-4 sm:p-6 space-y-6">
  <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
    <div>
      <h1 class="text-3xl font-bold">Ventas por sucursal (comparación en zona)</h1>
      <p class="text-sm opacity-70">Último año disponible, acumulado del período navideño.</p>
    </div>
    <a href="{% url 'sales:sales_curves' %}" class="btn btn-ghost btn-sm w-full sm:w-auto">Regresar</a>
  </div>

  <form id="filters" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 bg-base-100 p-4 rounded-xl shadow">
    <div class="sm:col-span-2 lg:col-span-2">
      <label class="label"><span class="label-text">Zona</span></label>
      <select class="select select-bordered w-full" name="zone_id" id="zone">
        {% for z in zones %}
          <option value="{{ z.id }}" {% if default_zone_id and z.id == default_zone_id %}selected{% endif %}>{{ z.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="sm:col-span-2 lg:col-span-2">
      <label class="label"><span class="label-text">Familia (opcional)</span></label>
      <select class="select select-bordered w-full" name="family_id" id="family">
        <option value="">Todas</option>
        {% for f in families %}
          <option value="{{ f.id }}">{{ f.origen }} ▸ {{ f.familia_std }} ▸ {{ f.subfamilia_std }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="sm:col-span-2 lg:col-span-4 flex justify-end">
      <button type="submit" class="btn btn-primary w-full sm:w-auto">Actualizar gráfico</button>
    </div>
  </form>

  <div class="bg-base-100 p-4 sm:p-6 rounded-xl shadow">
    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3 mb-4">
      <div>
        <h2 class="text-xl font-semibold">Sucursales de la zona</h2>
        <p id="metaInfo" class="text-xs opacity-60"></p>
      </div>
      <div class="flex gap-2 justify-end">
        <button id="zoneZoomIn" type="button" class="btn btn-xs">+</button>
        <button id="zoneZoomOut" type="button" class="btn btn-xs">-</button>
        <button id="zoneZoomReset" type="button" class="btn btn-xs">Reset</button>
      </div>
    </div>
    <div class="relative w-full h-64 sm:h-80">
      <canvas id="zoneChart" class="w-full h-full"></canvas>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2"></script>
<script>
const DATA_URL = "{% url 'sales:sales_by_zone_data' %}";
const $form = document.getElementById('filters');
const ctx = document.getElementById('zoneChart').getContext('2d');
const $meta = document.getElementById('metaInfo');
let chart;
if (window.Chart && window["chartjs-plugin-zoom"]) {
  Chart.register(window["chartjs-plugin-zoom"]);
}

function getPalette() {
  const s = getComputedStyle(document.documentElement);
  const chartKeys = Array.from({ length: 20 }, (_, i) => `--chart-${i + 1}`);
  const chartColors = chartKeys.map(k => (s.getPropertyValue(k) || '').trim()).filter(Boolean);
  const fallback = [
    '#2563eb', '#dc2626', '#16a34a', '#f59e0b', '#7c3aed',
    '#0ea5e9', '#f97316', '#be123c', '#22c55e', '#a855f7',
    '#14b8a6', '#ef4444', '#6366f1', '#84cc16', '#d946ef',
  ];

  const palette = [...chartColors];
  while (palette.length < 20) {
    palette.push(fallback[(palette.length - chartColors.length) % fallback.length]);
  }
  return palette.slice(0, 20);
}
function hexToRgba(hex, a) {
  if (!hex) return null;
  const h = hex.replace('#','');
  const full = h.length === 3 ? h.split('').map(c=>c+c).join('') : h;
  const bigint = parseInt(full,16);
  const r=(bigint>>16)&255, g=(bigint>>8)&255, b=bigint&255;
  return `rgba(${r}, ${g}, ${b}, ${a})`;
}
function formatDayLabel(label) {
  const m = /^(\d{1,2})-(\d{1,2})$/.exec(label || "");
  if (m) return `${m[2].padStart(2,'0')}/${m[1].padStart(2,'0')}`;
  return label || "";
}

function extractStoreCode(label) {
  const m = /^\s*(\d+)\b/.exec(label || "");
  return m ? m[1] : null;
}
function hashString(str) {
  let h = 5381;
  const s = String(str || "");
  for (let i = 0; i < s.length; i++) h = ((h << 5) + h) + s.charCodeAt(i); // djb2
  return h >>> 0;
}
function pickColorForLabel(palette, label, fallbackIdx) {
  const code = extractStoreCode(label);
  const safeBase = code ? hashString(code) : hashString(label);
  const len = palette.length || 1;
  const idx = (safeBase % len + len) % len;
  return palette[idx] || palette[fallbackIdx % len] || '#3b82f6';
}

function fetchData() {
  const params = new URLSearchParams(new FormData($form));
  fetch(`${DATA_URL}?${params.toString()}`)
    .then(r => r.json())
    .then(d => {
      const labels = (d.labels || []).map(formatDayLabel);
      const palette = getPalette();
      const datasets = (d.datasets || []).map((ds, idx) => {
        const color = pickColorForLabel(palette, ds.label, idx);
        return {
          label: ds.label,
          data: ds.data,
          borderColor: color,
          backgroundColor: hexToRgba(color, 0.12),
          tension: 0.3,
          borderWidth: 2,
          fill: false,
          spanGaps: true,
          pointRadius: 2,
        };
      });
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction:{mode:'index', intersect:false},
          scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },
          plugins: {
            legend: { display: true, position: 'top' },
            zoom:{
              pan:{ enabled:true, mode:'x' },
              zoom:{
                wheel:{ enabled:true },
                pinch:{ enabled:true },
                mode:'x'
              }
            }
          }
        }
      });

      const zone = d.meta?.zone_name || d.meta?.zone_id || '-';
      const total = d.meta?.total_units ?? '';
      const start = d.meta?.start_date || '';
      const end = d.meta?.end_date || '';
      $meta.textContent = `Zona: ${zone} · Período: ${start} a ${end} · Total ventas: ${total}`;
    })
    .catch(err => { console.error(err); $meta.textContent = "Error al cargar datos."; });
}

function bindZoomButtons() {
  const btnIn    = document.getElementById('zoneZoomIn');
  const btnOut   = document.getElementById('zoneZoomOut');
  const btnReset = document.getElementById('zoneZoomReset');
  if (btnIn)    btnIn.addEventListener('click', () => { if (chart) chart.zoom(1.2); });
  if (btnOut)   btnOut.addEventListener('click', () => { if (chart) chart.zoom(0.8); });
  if (btnReset) btnReset.addEventListener('click', () => { if (chart) chart.resetZoom(); });
}

$form.addEventListener('submit', e => { e.preventDefault(); fetchData(); });

document.addEventListener('DOMContentLoaded', () => {
  bindZoomButtons();
  fetchData();
});
</script>
{% endblock %}
